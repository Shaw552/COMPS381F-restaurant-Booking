<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Reservation - Restaurant Reservation System</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>New Reservation - <%= branch %></h1>
            <a href="/" class="btn-secondary">Back</a>
        </header>
        
        <% if (error) { %>
            <div class="error"><%= error %></div>
        <% } %>
        
        <% if (cooldownMessage) { %>
            <div class="cooldown-warning">
                <h3>⚠️ Reservation Cooldown</h3>
                <p><%= cooldownMessage %></p>
                <% if (cooldownUntil) { %>
                    <p id="cooldownTimer" class="cooldown-timer">Time remaining: <span id="countdownTime"></span></p>
                <% } %>
            </div>
        <% } %>
        
        <form method="POST" action="/reservations/create" class="reservation-form" id="reservationForm" <% if (cooldownUntil) { %>onsubmit="return false;"<% } %>>
            <input type="hidden" name="branch" value="<%= branch %>">
            
            <div class="form-group">
                <label>Select Date:</label>
                <input type="date" name="date" id="dateInput" value="<%= selectedDate %>" required>
            </div>
            
            <div class="form-group">
                <label>Select Time Slot:</label>
                <div class="time-slots-container">
                    <div class="time-slot-group">
                        <h3>12:00 - 16:00</h3>
                        <div class="time-slots" id="timeSlots12-16">
                            <!-- Time slots will be generated by JavaScript -->
                        </div>
                    </div>
                    <div class="time-slot-group">
                        <h3>17:00 - 21:00</h3>
                        <div class="time-slots" id="timeSlots17-21">
                            <!-- Time slots will be generated by JavaScript -->
                        </div>
                    </div>
                </div>
                <input type="hidden" name="time" id="selectedTime" required>
                <div id="timeError" class="error" style="display:none;">Please select a time slot</div>
            </div>
            
            <div class="form-group">
                <label>Number of Adults:</label>
                <input type="number" name="adults" id="adultsInput" min="1" value="1" required>
            </div>
            
            <div class="form-group">
                <label>Number of Children:</label>
                <input type="number" name="children" id="childrenInput" min="0" value="0" required>
            </div>
            
            <div class="form-group">
                <label>Total People: <span id="totalPeople">1</span> / 12</span></label>
                <div id="peopleError" class="error" style="display:none;">Total number of people cannot exceed 12</div>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn-primary">Confirm Reservation</button>
                <a href="/" class="btn-secondary">Cancel</a>
            </div>
        </form>
        
        <script type="application/json" id="timeSlotsData"><%- JSON.stringify(timeSlots || []) %></script>
    </div>
    
    <script>
        const branch = '<%= branch %>';
        const selectedDate = '<%= selectedDate %>';
        const timeSlots = JSON.parse(document.getElementById('timeSlotsData').textContent);
        
        // Set min and max date for date input (December 2025 only)
        const dateInput = document.getElementById('dateInput');
        dateInput.min = '2025-12-01';
        dateInput.max = '2025-12-31';
        
        // Generate time slot buttons
        function generateTimeSlots() {
            const slots12_16 = timeSlots.filter(t => {
                const hour = parseInt(t.split(':')[0]);
                return hour >= 12 && hour <= 16;
            });
            
            const slots17_21 = timeSlots.filter(t => {
                const hour = parseInt(t.split(':')[0]);
                return hour >= 17 && hour <= 21;
            });
            
            renderTimeSlots('timeSlots12-16', slots12_16);
            renderTimeSlots('timeSlots17-21', slots17_21);
        }
        
        function renderTimeSlots(containerId, slots) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            slots.forEach(slot => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'time-slot-btn';
                button.textContent = slot;
                button.dataset.time = slot;
                button.onclick = () => selectTimeSlot(slot, button);
                container.appendChild(button);
            });
        }
        
        let selectedTimeBtn = null;
        
        function selectTimeSlot(time, button) {
            // Remove previous selection
            if (selectedTimeBtn) {
                selectedTimeBtn.classList.remove('selected');
            }
            
            // Select new time
            button.classList.add('selected');
            selectedTimeBtn = button;
            document.getElementById('selectedTime').value = time;
            document.getElementById('timeError').style.display = 'none';
            
            // Update availability if date is selected
            if (dateInput.value) {
                updateTimeSlotAvailability();
            }
        }
        
        // Update time slot availability when date changes
        dateInput.addEventListener('change', async () => {
            if (dateInput.value) {
                await updateTimeSlotAvailability();
            }
        });
        
        async function updateTimeSlotAvailability() {
            const date = dateInput.value;
            if (!date) return;
            
            try {
                const response = await fetch(`/api/reservations?branch=${encodeURIComponent(branch)}&date=${date}&status=active`);
                const reservations = await response.json();
                
                // Count reservations per time slot
                const slotCounts = {};
                reservations.forEach(res => {
                    slotCounts[res.time] = (slotCounts[res.time] || 0) + 1;
                });
                
                // Update button availability
                document.querySelectorAll('.time-slot-btn').forEach(btn => {
                    const time = btn.dataset.time;
                    const count = slotCounts[time] || 0;
                    const available = 5 - count;
                    
                    btn.disabled = available <= 0;
                    btn.title = `Available: ${available} / 5`;
                    
                    if (available <= 0) {
                        btn.classList.add('full');
                    } else {
                        btn.classList.remove('full');
                        const badge = btn.querySelector('.availability-badge') || document.createElement('span');
                        badge.className = 'availability-badge';
                        badge.textContent = `${available} left`;
                        if (!btn.querySelector('.availability-badge')) {
                            btn.appendChild(badge);
                        }
                    }
                });
            } catch (error) {
                console.error('Error fetching availability:', error);
            }
        }
        
        // Validate total people
        function updateTotalPeople() {
            const adults = parseInt(document.getElementById('adultsInput').value) || 0;
            const children = parseInt(document.getElementById('childrenInput').value) || 0;
            const total = adults + children;
            
            document.getElementById('totalPeople').textContent = total;
            
            const peopleError = document.getElementById('peopleError');
            if (total > 12) {
                peopleError.style.display = 'block';
                return false;
            } else {
                peopleError.style.display = 'none';
                return true;
            }
        }
        
        document.getElementById('adultsInput').addEventListener('input', updateTotalPeople);
        document.getElementById('childrenInput').addEventListener('input', updateTotalPeople);
        
        // Form validation
        document.getElementById('reservationForm').addEventListener('submit', (e) => {
            if (!updateTotalPeople()) {
                e.preventDefault();
                return false;
            }
            
            if (!document.getElementById('selectedTime').value) {
                e.preventDefault();
                document.getElementById('timeError').style.display = 'block';
                return false;
            }
        });
        
        // Cooldown countdown
        const cooldownUntilStr = '<%= cooldownUntil || "" %>';
        if (cooldownUntilStr) {
            const cooldownUntil = new Date(cooldownUntilStr);
            
            function updateCooldownTimer() {
                const now = new Date();
                const diff = cooldownUntil - now;
                
                if (diff <= 0) {
                    const timerEl = document.getElementById('cooldownTimer');
                    if (timerEl) {
                        timerEl.textContent = 'Cooldown period has ended. You can now make a reservation.';
                    }
                    const form = document.getElementById('reservationForm');
                    if (form) {
                        form.onsubmit = null;
                        form.querySelectorAll('input, select, button[type="submit"]').forEach(el => {
                            el.disabled = false;
                        });
                    }
                    const warning = document.querySelector('.cooldown-warning');
                    if (warning) {
                        warning.style.background = '#d4edda';
                        warning.style.borderColor = '#c3e6cb';
                    }
                    return;
                }
                
                const minutes = Math.floor(diff / 1000 / 60);
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                const countdownEl = document.getElementById('countdownTime');
                if (countdownEl) {
                    countdownEl.textContent = minutes + ':' + seconds.toString().padStart(2, '0');
                }
            }
            
            // Disable form during cooldown
            const form = document.getElementById('reservationForm');
            if (form) {
                form.querySelectorAll('input, select, button[type="submit"]').forEach(el => {
                    el.disabled = true;
                });
            }
            
            // Update timer every second
            updateCooldownTimer();
            setInterval(updateCooldownTimer, 1000);
        }
        
        // Initialize
        generateTimeSlots();
        if (selectedDate) {
            updateTimeSlotAvailability();
        }
    </script>
</body>
</html>
